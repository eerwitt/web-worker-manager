/*! web-worker-manager - v0.1.0 - 2014-08-18 */(function(){"use strict";var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}};b=null!=b?b:this,b.STATUS=Object.freeze({IDLE:"idle",BUSY:"busy",WAITING:"waiting",STARTING:"starting",ERROR:"error"}),a=function(){function a(a,b,d){var e,f,g;for(this.workerScriptLocation=a,this.poolSize=null!=b?b:2,this.workerClass=null!=d?d:Worker,this._completedWork=c(this._completedWork,this),this._handleWorker=c(this._handleWorker,this),this._handleErrors=c(this._handleErrors,this),this.pool=[],this.queue=[],this.jobs={},e=f=0,g=this.poolSize;g>=0?g>f:f>g;e=g>=0?++f:--f)this._createWorker("worker_"+e)}return a.prototype._validateRequirements=function(){if("undefined"==typeof Q||null===Q||null==this.workerClass||null==this.workerScriptLocation)throw new Error("Unable to initialize WebWorkerManager due to a missing parameter. Q found... "+("undefined"!=typeof Q&&null!==Q)+" WorkerClass found... "+(null!=this.workerClass))},a.prototype._createWorker=function(a){var b;return this._validateRequirements(),b=new this.workerClass(this.workerScriptLocation),b.addEventListener("message",function(b){return function(c){return b._handleWorker(a,c)}}(this)),b.addEventListener("error",function(b){return function(c){var d,e;return d={data:{messageType:"error",params:{error:null!=c&&null!=(e=c.data)?e.error:void 0}}},b._handleWorker(a,d),b._handleErrors(a)}}(this)),this.pool.push({thread:b,id:a,status:STATUS.STARTING})},a.prototype._getWorkerById=function(a){var b;if(b=this.pool.filter(function(b){return b.id===a}),b.length>1)throw new Error("More than 1 worker has the same ID. "+a);if(0===b.length)throw new Error("No worker found with that ID. "+a);return b[0]},a.prototype._handleErrors=function(a){var b,c,d;d=this._getWorkerById(a),d.status=STATUS.ERROR;try{d.thread.terminate()}catch(e){b=e}return c=""+a+".resqued",this._createWorker(c)},a.prototype._handleWorker=function(a,b){var c,d,e,f;switch(c=null!=b&&null!=(e=b.data)?e.messageType:void 0,d=null!=b&&null!=(f=b.data)?f.params:void 0,c){case"ready":return this._updateWorkerToIdle(this._getWorkerById(a));case"progress":return this.jobs[a].notify(d.current/d.total);case"complete":return this.jobs[a].resolve(d.payload);case"error":return this.jobs[a].reject(d.error);default:throw new Error("An unknown event was sent back to the Manager.")}},a.prototype._updateWorkerToIdle=function(a){var b;if(null==a)throw new Error("No worker was specified to be set to IDLE.");return a.status=STATUS.IDLE,b=this.queue.shift(),null!=b?b(a):void 0},a.prototype._completedWork=function(a){return this._updateWorkerToIdle(a)},a.prototype._addToQueue=function(a){if("function"!=typeof a)throw new Error("The callback being added to the queue is not a function.");return this.queue.push(a)},a.prototype.getWorker=function(){return Q.Promise(function(a){return function(b){var c,d,e,f,g;for(c=null,g=a.pool,e=0,f=g.length;f>e;e++)if(d=g[e],d.status===STATUS.IDLE){c=d;break}return null!=c?b(c):a._addToQueue(function(a){return b(a)})}}(this))},a.prototype.runJob=function(a,b){var c;if(null==b&&(b={}),null==a)throw new Error("The name of the job to execute is required.");return c=function(c){return function(d){return d.status=STATUS.BUSY,Q.Promise(function(e,f,g){return c.jobs[d.id]={job:a,notify:g,resolve:function(a){return e(a),c._completedWork(d)},reject:function(a){return f(a),c._completedWork(d)}},d.thread.postMessage({messageType:a,params:b})})}}(this),this.getWorker().then(c)},a}(),b.WebWorkerManager=a}).call(this);